using System.IO;
using UnityEngine;
using UnityEngine.UI;
using UnityEngine.TestTools;
using NUnit.Framework;
using System.Collections;
using UnityEditor;

public class NestedCanvas : IPrebuildSetup
{
    Object m_GO1;
    Object m_GO2;

    const string kPrefabPath = "Assets/Resources/NestedCanvasPrefab.prefab";

    public void Setup()
    {
#if UNITY_EDITOR

        var rootGO = new GameObject("RootGO");

        var rootCanvasGO = new GameObject("Canvas", typeof(Canvas), typeof(CanvasGroup));
        rootCanvasGO.transform.SetParent(rootGO.transform);

        var nestedCanvas = new GameObject("Nested Canvas", typeof(Canvas), typeof(Image));
        nestedCanvas.transform.SetParent(rootCanvasGO.transform);

        var nestedCanvasCamera = new GameObject("Nested Canvas Camera", typeof(Camera));
        nestedCanvasCamera.transform.SetParent(rootCanvasGO.transform);

        var rootCanvas = rootCanvasGO.GetComponent<Canvas>();
        rootCanvas.renderMode = RenderMode.WorldSpace;
        rootCanvas.worldCamera = nestedCanvasCamera.GetComponent<Camera>();

        if (!Directory.Exists("Assets/Resources/"))
            Directory.CreateDirectory("Assets/Resources/");

        UnityEditor.PrefabUtility.SaveAsPrefabAsset(rootGO, kPrefabPath);
        GameObject.DestroyImmediate(rootGO);
#endif
    }

    [UnityTest]
    [Description("[UI] Button does not interact after nested canvas is used(case 892913)")]
    public IEnumerator WorldCanvas_CanFindCameraAfterDisablingAndEnablingRootCanvas()
    {
        m_GO1 = Object.Instantiate(Resources.Load("NestedCanvasPrefab"));
        yield return null;

        var nestedCanvasGo = GameObject.Find("Nested Canvas");
        var nestedCanvas = nestedCanvasGo.GetComponent<Canvas>();
        Assert.IsNotNull(nestedCanvas.worldCamera, "Expected the nested canvas worldCamera to NOT be null after loading the scene.");

        nestedCanvasGo.transform.parent.gameObject.SetActive(false);
        nestedCanvasGo.transform.parent.gameObject.SetActive(true);
        Assert.IsNotNull(nestedCanvas.worldCamera, "Expected the nested canvas worldCamera to NOT be null after the parent canvas has been re-enab